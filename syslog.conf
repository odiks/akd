# Modules requis
module(load="imuxsock") # Input module for local system logs
module(load="imklog")   # Kernel log input
module(load="omfwd")    # Forwarding module
module(load="builtin:omfile") # Local file output
module(load="queue")    # Queue support

# Paramètres globaux
global(workDirectory="/var/spool/rsyslog") # Répertoire pour le spool local
global(defaultNetstreamDriver="gtls")     # Optionnel pour TLS (ajuster si nécessaire)
global(action.resumeRetryCount="-1")      # Réessayer indéfiniment si un serveur est indisponible

# Configuration de la file d'attente (spooling)
queue.type="LinkedList"                   # Utiliser une file chaînée
queue.filename="syslog_spool"             # Nom de la file pour stockage
queue.maxdiskspace="1g"                   # Taille max du spool (1 Go ici, ajustez selon vos besoins)
queue.saveonshutdown="on"                 # Sauvegarder les messages non envoyés au redémarrage
queue.dequeueBatchSize="1000"             # Nombre de messages à traiter par lot

# Paramètres des serveurs Syslog avec DNS round-robin
action(
    type="omfwd"
    target="syslog"          # DNS avec round-robin (syslog-1, syslog-2, syslog-3)
    port="514"               # Port Syslog UDP standard
    protocol="udp"           # Protocole à utiliser (ajustez à TCP si nécessaire)
    name="dns_round_robin"
    action.execOnlyWhenPreviousIsSuspended="on" # Priorité à syslog-1, puis syslog-2, etc.
)

# Option pour spooling local si aucun serveur Syslog n'est accessible
if (not $action.complete) then {
    action(type="omfile" file="/var/log/syslog_spool.log")
}

# Logs locaux (pour conservation standard)
*.* /var/log/messages

# Filtre spécifique si besoin (exemple: envoyer uniquement authpriv logs)
authpriv.* action(
    type="omfwd"
    target="syslog"
    port="514"
    protocol="udp"
)
